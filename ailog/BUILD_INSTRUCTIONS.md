# Producer Pal - Build Instructions

## üö® Important: Why the .amxd File Doesn't Work

The `Producer_Pal.amxd` Max for Live device requires **compiled JavaScript bundles** that must be built from source. The device won't work without these files:

- `max-for-live-device/live-api-adapter.js` - Main V8 runtime code
- `max-for-live-device/mcp-server.mjs` - MCP server with new browser tools
- `max-for-live-device/chat-ui.html` - Web UI (optional)
- `max-for-live-device/portal.mjs` - Stdio-HTTP bridge

**These files are NOT included in the repository** - they must be generated by running the build process.

---

## ‚úÖ Prerequisites

Before building, you need:

1. **Node.js** version 24 or higher
   - Download: https://nodejs.org/
   - Verify: `node --version`

2. **npm** (comes with Node.js)
   - Verify: `npm --version`

3. **Git** (optional, for version control)
   - Download: https://git-scm.com/

---

## üîß Step-by-Step Build Process

### 1. Extract the Archive

```bash
# Windows (using 7-Zip, WinRAR, or tar)
tar -xzf producer-pal-browser-implementation.tar.gz
cd producer-pal-1.3.6

# Or if already extracted
cd producer-pal-1.3.6
```

### 2. Install Dependencies

```bash
npm install
```

**Expected output:** This will install ~200MB of dependencies in `node_modules/`

### 3. Build Everything

```bash
# Build with all tools (includes browser functionality)
npm run build:all
```

**This command does:**
1. Builds the bar|beat notation parser
2. Builds the modulation notation parser
3. Builds the chat UI (web interface)
4. **Bundles TypeScript ‚Üí JavaScript for Max**
5. Creates the MCP server bundle with browser tools
6. Creates the portal (stdio-HTTP bridge)
7. Builds additional debugging tools

**Expected output:** Build completes in 30-60 seconds

### 4. Verify Build Success

Check that these files were created:

```bash
# Windows
dir max-for-live-device\*.js
dir max-for-live-device\*.mjs
dir max-for-live-device\*.html

# Linux/Mac
ls -lh max-for-live-device/*.{js,mjs,html}
```

**Required files:**
- ‚úÖ `live-api-adapter.js` (~500KB) - Core runtime
- ‚úÖ `mcp-server.mjs` (~3MB) - MCP server with browser tools
- ‚úÖ `portal.mjs` (~1MB) - Communication bridge
- ‚úÖ `chat-ui.html` (~500KB) - Web interface
- ‚úÖ `ppal-raw-live-api.mjs` (optional) - Debug tool

---

## üéµ Using the Built Device

### Load in Ableton Live

1. Open Ableton Live
2. Drag `Producer_Pal.amxd` onto any MIDI track
3. The device should now show "Server: Ready" status
4. Configure your AI provider (Claude, Gemini, etc.)

### Verify Browser Tools Work

You can test the new browser tools:

1. **Connect to Producer Pal:**
   - Using Claude Desktop (MCP client)
   - Or using the Chat UI tab in the device

2. **Test browsing:**
   ```
   "List instruments from the library"
   ```
   ‚Üí Should call `ppal-read-browser`

3. **Test loading:**
   ```
   "Load an analog bass preset"
   ```
   ‚Üí Should call `ppal-read-browser` then `ppal-load-item`

---

## üêõ Troubleshooting

### "npm: command not found"

**Problem:** Node.js is not installed or not in PATH

**Solution:**
1. Install Node.js 24+ from https://nodejs.org/
2. Restart your terminal/command prompt
3. Verify: `node --version`

### "Module not found" errors during build

**Problem:** Dependencies not installed

**Solution:**
```bash
# Remove old node_modules
rm -rf node_modules package-lock.json

# Reinstall
npm install
```

### Build succeeds but device shows errors

**Problem:** Build didn't include browser tools

**Solution:**
```bash
# Use build:all instead of build
npm run build:all
```

The `build:all` command sets `ENABLE_RAW_LIVE_API=true` which includes debugging tools.

### "Cannot find module" in Max console

**Problem:** JavaScript bundles not in the right location

**Solution:**
1. Verify files exist in `max-for-live-device/`
2. Check file sizes (should be several hundred KB to several MB)
3. Re-save the `.amxd` device in Max after building

### Browser tools not appearing

**Problem:** MCP server wasn't rebuilt with new tools

**Solution:**
```bash
# Clean build
npm run clean  # if available
npm run build:all
```

---

## üîÑ Development Workflow

### Watch Mode (Auto-rebuild on changes)

```bash
# Watch for changes and rebuild automatically
npm run dev
```

### Running Tests

```bash
# Run all tests
npm test

# Run tests with coverage
npm run test:coverage

# Watch mode for tests
npm run test:watch
```

### Quality Checks

```bash
# Auto-fix formatting and linting
npm run fix

# Run all quality checks
npm run check
```

This runs:
- ESLint (linting)
- TypeScript type checking
- Prettier (formatting)
- Vitest (tests with coverage)
- jscpd (code duplication check)

---

## üì¶ Creating a Distribution Package

### Option 1: Build and Share Entire Folder

```bash
# After building
cd ..
tar -czf producer-pal-built.tar.gz producer-pal-1.3.6/
```

This creates a ~35MB archive with all built files.

### Option 2: Share Only the Device

After building, you can share just the `max-for-live-device/` folder, which includes:
- `Producer_Pal.amxd` - The device
- `*.js`, `*.mjs` - Built bundles
- `*.html` - Chat UI
- `*.maxpat` - Sub-patches

**Size:** ~5MB

Users can drag `Producer_Pal.amxd` directly into Ableton Live.

---

## üîç What the Build Process Does

### 1. Parser Build (`npm run parser:build`)

Generates parsers from PEGjs grammar files:
- `src/notation/barbeat/parser/generated-barbeat-parser.js`
- `src/notation/modulation/parser/generated-modulation-parser.js`

These parse musical notation strings like `"1.1.1"` (bar, beat, sixteenth).

### 2. UI Build (`npm run ui:build`)

Bundles the web-based chat interface using Vite:
- Input: `webui/src/main.tsx`
- Output: `max-for-live-device/chat-ui.html` (single file)

### 3. Rollup Build

Creates 3 JavaScript bundles:

**a) `live-api-adapter.js`**
- Runs in Max's V8 JavaScript engine
- Handles all Live API communication
- Dispatches tool calls
- **Includes new browser tool implementations**

**b) `mcp-server.mjs`**
- Node.js MCP server
- Registers all tools with MCP SDK
- **Includes ppal-read-browser and ppal-load-item**
- Handles HTTP requests from portal

**c) `portal.mjs`**
- Stdio-HTTP bridge
- Connects MCP clients to the server
- Runs as Node.js subprocess

### 4. Debug Tools Build (with `build:all`)

Creates additional debugging tools:
- `ppal-raw-live-api.mjs` - Direct Live API access

---

## üöÄ Quick Reference

```bash
# Complete build from scratch
npm install && npm run build:all

# Verify it worked
ls -lh max-for-live-device/*.{js,mjs,html}

# Run tests
npm test

# Clean rebuild (if needed)
rm -rf node_modules package-lock.json
npm install
npm run build:all
```

---

## ‚ö†Ô∏è Common Mistakes

1. **Running `npm run build` instead of `npm run build:all`**
   - Use `build:all` to include all tools

2. **Not running `npm install` first**
   - Dependencies must be installed before building

3. **Using old Node.js version**
   - Need Node.js 24+ (check with `node --version`)

4. **Building on one OS, using on another**
   - Builds are cross-platform compatible
   - No OS-specific compilation needed

5. **Not rebuilding after code changes**
   - Changes to `src/` require rebuild
   - Use `npm run dev` for auto-rebuild

---

## üìû Support

If the build still doesn't work:

1. Check Node.js version: `node --version` (need 24+)
2. Check npm version: `npm --version`
3. Try clean install: `rm -rf node_modules && npm install`
4. Check disk space: Build needs ~500MB
5. Review build output for specific errors

**The device CANNOT work without building first!** The `.amxd` file is just a container - it needs the compiled JavaScript bundles to actually run.

---

## ‚úÖ Success Checklist

Before using the device:
- ‚òë Node.js 24+ installed
- ‚òë `npm install` completed successfully
- ‚òë `npm run build:all` completed without errors
- ‚òë Files exist in `max-for-live-device/`:
  - `live-api-adapter.js`
  - `mcp-server.mjs`
  - `portal.mjs`
  - `chat-ui.html`
- ‚òë Device loads in Ableton Live
- ‚òë Server shows "Ready" status
- ‚òë Browser tools appear in tool list

**Now you're ready to use Producer Pal with browser management!** üéâ
